<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Blood Connect â€” Chat</title>
    <style>
      :root{
        --accent:#D62828; /* primary */
        --bg:#FAFAFB;
        --bot:#F4F6F8;
        --card-radius:12px;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      }
      body{margin:0;background:var(--bg);display:flex;flex-direction:column;height:100vh}
      header{background:white;padding:12px 16px;box-shadow:0 1px 0 rgba(0,0,0,0.06);display:flex;align-items:center;gap:12px}
      header h1{font-size:16px;margin:0}
      main{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
      .bubble{padding:10px 12px;border-radius:var(--card-radius);max-width:78%;}
      .bot{background:var(--bot);align-self:flex-start}
      .user{background:var(--accent);color:white;align-self:flex-end}
      .inputbar{padding:12px;display:flex;gap:8px;align-items:center;background:white}
      .chips{display:flex;gap:8px;overflow:auto;padding:8px}
      .chip{background:white;border:1px solid #eee;padding:8px 10px;border-radius:999px;font-size:14px;cursor:pointer}
      .input{flex:1;display:flex;gap:8px;align-items:center}
      .text-input{flex:1;padding:10px 12px;border-radius:20px;border:1px solid #eee}
      .btn{background:var(--accent);color:white;padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
      .tiny{font-size:12px;color:#666}
      .preview{display:flex;gap:8px;align-items:center}
      .preview img{height:56px;border-radius:8px}
    </style>
  </head>
  <body>
    <header>
      <div style="width:40px;height:40px;border-radius:8px;background:var(--accent);"></div>
      <h1>Blood Connect</h1>
    </header>
    <main id="messages"></main>

    <div class="chips" id="chips">
      <div class="chip" data-payload="under_18">Can I donate if I'm under 18?</div>
      <div class="chip" data-payload="where_near">Where can I donate near me?</div>
      <div class="chip" data-payload="urgent">Urgent: I need blood now</div>
    </div>

    <div class="inputbar">
      <input id="fileInput" type="file" accept="image/*,audio/*" style="display:none" />
      <button id="attachBtn" class="btn" style="background:#fff;color:var(--accent);border:1px solid #eee">+</button>
      <div class="input">
        <input id="textInput" class="text-input" placeholder="Type a message or use quick suggestions" />
        <button id="micBtn" class="btn" style="background:#fff;color:var(--accent);border:1px solid #eee">ðŸŽ¤</button>
        <button id="sendBtn" class="btn">Send</button>
      </div>
    </div>

    <script>
      const messagesEl = document.getElementById('messages')
      const textInput = document.getElementById('textInput')
      const sendBtn = document.getElementById('sendBtn')
      const attachBtn = document.getElementById('attachBtn')
      const fileInput = document.getElementById('fileInput')
      const chips = document.getElementById('chips')

      function appendMessage(text, cls='bot'){
        const d = document.createElement('div')
        d.className = cls + ' bubble'
        d.textContent = text
        messagesEl.appendChild(d)
        messagesEl.scrollTop = messagesEl.scrollHeight
      }

      // Create a bot bubble with a typing indicator and return the element so it can be updated
      function appendBotTyping(){
        const d = document.createElement('div')
        d.className = 'bot bubble'
        d.textContent = 'Thinking...'
        d.style.opacity = '0.9'
        messagesEl.appendChild(d)
        messagesEl.scrollTop = messagesEl.scrollHeight
        return d
      }

      sendBtn.addEventListener('click', async ()=>{
        const text = textInput.value.trim()
        if(!text) return
        appendMessage(text, 'user')
        textInput.value = ''
        // show dynamic typing bubble
        const typingBubble = appendBotTyping()
        sendBtn.disabled = true
          try{
            const res = await fetch('./api/send/', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})})
            if(!res.ok){
              // try to show server-provided JSON error
              let body = null
              try{ body = await res.json() }catch(e){ body = await res.text().catch(()=>null) }
              if(body && typeof body === 'object' && body.error) typingBubble.textContent = 'Error: '+body.error
              else if(body) typingBubble.textContent = 'Error: '+String(body)
              else typingBubble.textContent = 'Error: server returned status '+res.status
            } else {
              const j = await res.json()
              typingBubble.textContent = j.reply.text
            }
          }catch(err){
            typingBubble.textContent = 'Network error. '+err.message
          }finally{
            sendBtn.disabled = false
          }
      })

      chips.addEventListener('click', async (e)=>{
        const chip = e.target.closest('.chip')
        if(!chip) return
        const text = chip.textContent
        appendMessage(text, 'user')
        const typingBubble = appendBotTyping()
          try{
            const res = await fetch('./api/send/', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})})
            if(!res.ok){
              let body = null
              try{ body = await res.json() }catch(e){ body = await res.text().catch(()=>null) }
              if(body && typeof body === 'object' && body.error) typingBubble.textContent = 'Error: '+body.error
              else if(body) typingBubble.textContent = 'Error: '+String(body)
              else typingBubble.textContent = 'Error: server returned status '+res.status
            } else {
              const j = await res.json()
              typingBubble.textContent = j.reply.text
            }
          }catch(err){
            typingBubble.textContent = 'Network error. '+err.message
          }
      })

      attachBtn.addEventListener('click', ()=> fileInput.click())

      fileInput.addEventListener('change', async ()=>{
        if(!fileInput.files.length) return
        const f = fileInput.files[0]
        const form = new FormData()
        form.append('file', f)
        appendMessage('Uploading...', 'user')
        const typingBubble = appendBotTyping()
          try{
            const res = await fetch('./api/upload/', {method:'POST',body:form})
            if(!res.ok){
              let body = null
              try{ body = await res.json() }catch(e){ body = await res.text().catch(()=>null) }
              if(body && typeof body === 'object' && body.error) typingBubble.textContent = 'Upload error: '+body.error
              else if(body) typingBubble.textContent = 'Upload error: '+String(body)
              else typingBubble.textContent = 'Upload failed: status '+res.status
              return
            }
            const j = await res.json()
            typingBubble.textContent = 'File uploaded: '+j.url
          }catch(err){
            typingBubble.textContent = 'Upload error. '+err.message
          }
      })

      // Basic mic recording using MediaRecorder
      let mediaRecorder, audioChunks=[]
      const micBtn = document.getElementById('micBtn')
      micBtn.addEventListener('click', async ()=>{
        if(mediaRecorder && mediaRecorder.state === 'recording'){
          mediaRecorder.stop()
          micBtn.textContent = 'ðŸŽ¤'
          return
        }
        try{
          const stream = await navigator.mediaDevices.getUserMedia({audio:true})
          mediaRecorder = new MediaRecorder(stream)
          audioChunks = []
          mediaRecorder.ondataavailable = e=>audioChunks.push(e.data)
          mediaRecorder.onstop = async ()=>{
            const blob = new Blob(audioChunks,{type:'audio/webm'})
            const form = new FormData()
            form.append('file', blob, 'recording.webm')
            appendMessage('Uploading audio...', 'user')
            const typingBubble = appendBotTyping()
              try{
                const res = await fetch('./api/upload/', {method:'POST',body:form})
                if(!res.ok){
                  let body = null
                  try{ body = await res.json() }catch(e){ body = await res.text().catch(()=>null) }
                  if(body && typeof body === 'object' && body.error) typingBubble.textContent = 'Upload error: '+body.error
                  else if(body) typingBubble.textContent = 'Upload error: '+String(body)
                  else typingBubble.textContent = 'Upload failed: status '+res.status
                  return
                }
                const j = await res.json()
                typingBubble.textContent = 'Audio uploaded: '+j.url
              }catch(err){
                typingBubble.textContent = 'Upload error. '+err.message
              }
          }
          mediaRecorder.start()
          micBtn.textContent = 'â– '
        }catch(err){
          alert('Microphone access denied')
        }
      })

    </script>
  </body>
</html>
